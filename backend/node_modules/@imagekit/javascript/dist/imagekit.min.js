!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).ImageKit={})}(this,(function(e){"use strict";const t={width:"w",height:"h",aspectRatio:"ar",background:"bg",border:"b",crop:"c",cropMode:"cm",dpr:"dpr",focus:"fo",quality:"q",x:"x",xCenter:"xc",y:"y",yCenter:"yc",format:"f",videoCodec:"vc",audioCodec:"ac",radius:"r",rotation:"rt",blur:"bl",named:"n",defaultImage:"di",flip:"fl",original:"orig",startOffset:"so",endOffset:"eo",duration:"du",streamingResolutions:"sr",grayscale:"e-grayscale",aiUpscale:"e-upscale",aiRetouch:"e-retouch",aiVariation:"e-genvar",aiDropShadow:"e-dropshadow",aiChangeBackground:"e-changebg",aiEdit:"e-edit",aiRemoveBackground:"e-bgremove",aiRemoveBackgroundExternal:"e-removedotbg",contrastStretch:"e-contrast",shadow:"e-shadow",sharpen:"e-sharpen",unsharpMask:"e-usm",gradient:"e-gradient",colorReplace:"cr",distort:"e-distort",progressive:"pr",lossless:"lo",colorProfile:"cp",metadata:"md",opacity:"o",trim:"t",zoom:"z",page:"pg",layerMode:"lm",fontSize:"fs",fontFamily:"ff",fontColor:"co",innerAlignment:"ia",padding:"pa",alpha:"al",typography:"tg",lineHeight:"lh",fontOutline:"fol",fontShadow:"fsh",raw:"raw"};var r=e=>"query"===e.transformationPosition,n=function(e){return e&&(t[e]||t[e.toLowerCase()])||""},s=function(){return":"},o=function(){return","},a=function(){return"-"};const i=function(e){return"undefined"!=typeof window?btoa(e):Buffer.from(e,"utf8").toString("base64")},u=new RegExp("^[a-zA-Z0-9-._/ ]*$"),c=new RegExp("^[a-zA-Z0-9-._ ]*$");function p(e){return"string"==typeof e&&"/"==e[e.length-1]&&(e=e.substring(0,e.length-1)),e}function l(e){return"string"==typeof e&&"/"==e[0]&&(e=e.slice(1)),e}function d(e,t){var r=t||"/",n=new RegExp(r+"{1,}","g");return e.join(r).replace(n,r)}const f=e=>{if(e.urlEndpoint=e.urlEndpoint||"",e.src=e.src||"",e.transformationPosition=e.transformationPosition||"query",!e.src)return"";const t=e.src.startsWith("http://")||e.src.startsWith("https://");var n,o,a;try{t?(n=new URL(e.src),o=!0):(a=new URL(e.urlEndpoint).pathname,n=new URL(d([e.urlEndpoint.replace(a,""),e.src])))}catch(e){return console.error(e),""}for(var i in e.queryParameters)n.searchParams.append(i,String(e.queryParameters[i]));var u=h(e.transformation);return u&&u.length&&(r(e)||o||(n.pathname=d(["tr"+s()+u,n.pathname]))),n.pathname=d(a?[a,n.pathname]:[n.pathname]),u&&u.length&&(r(e)||o)?""!==n.searchParams.toString()?`${n.href}&tr=${u}`:`${n.href}?tr=${u}`:n.href};function g(e,t){return e=p(l(e)),"plain"===t?"i-"+e.replace(/\//g,"@@"):"base64"===t?"ie-"+encodeURIComponent(i(e)):u.test(e)?"i-"+e.replace(/\//g,"@@"):"ie-"+encodeURIComponent(i(e))}function m(e){const t=[],{type:r,layerMode:n,position:s={},timing:a={},transformation:u=[]}=e||{};if(!r)return;switch(r){case"text":{const r=e;if(!r.text)return;const n=r.encoding||"auto";t.push("l-text"),t.push(function(e,t){return"plain"===t?"i-"+encodeURIComponent(e):"base64"===t?"ie-"+encodeURIComponent(i(e)):c.test(e)?"i-"+encodeURIComponent(e):"ie-"+encodeURIComponent(i(e))}(r.text,n))}break;case"image":t.push("l-image");{const r=e,n=r.encoding||"auto";if(!r.input)return;t.push(g(r.input,n))}break;case"video":t.push("l-video");{const r=e,n=r.encoding||"auto";if(!r.input)return;t.push(g(r.input,n))}break;case"subtitle":t.push("l-subtitles");{const r=e,n=r.encoding||"auto";if(!r.input)return;t.push(g(r.input,n))}break;case"solidColor":t.push("l-image"),t.push("i-ik_canvas");{const r=e;if(!r.color)return;t.push("bg-"+r.color)}}n&&t.push("lm-"+n);const{x:p,y:l,focus:d}=s;p&&t.push("lx-"+p),l&&t.push("ly-"+l),d&&t.push("lfo-"+d);const{start:f,end:m,duration:y}=a;f&&t.push("lso-"+f),m&&t.push("leo-"+m),y&&t.push("ldu-"+y);const v=h(u);return v&&""!==v.trim()&&t.push(v),t.push("l-end"),t.join(o())}const h=function(e){if(!Array.isArray(e))return"";for(var t=[],r=0,i=e.length;r<i;r++){var u=[];for(var c in e[r]){let t=e[r][c];if(null!=t)if("overlay"!==c||"object"!=typeof t){var d=n(c);if(d||(d=c),""!==d)if(["e-grayscale","e-contrast","e-removedotbg","e-bgremove","e-upscale","e-retouch","e-genvar"].includes(d)){if(!0!==t&&"-"!==t&&"true"!==t)continue;u.push(d)}else!["e-sharpen","e-shadow","e-gradient","e-usm","e-dropshadow"].includes(d)||""!==t.toString().trim()&&!0!==t&&"true"!==t?"raw"===c?u.push(e[r][c]):("di"===d&&(t=p(l(t||"")),t=t.replace(/\//g,"@@")),"sr"===d&&Array.isArray(t)&&(t=t.join("_")),"t"===d&&""===t.toString().trim()&&(t="true"),u.push([d,t].join(a()))):u.push(d)}else{var f=m(t);f&&""!==f.trim()&&u.push(f)}}u.length&&t.push(u.join(o()))}return t.join(s())},y=[640,750,828,1080,1200,1920,2048,3840],v=[16,32,48,64,96,128,256,384];var b={message:"Missing file parameter for upload"},w={message:"Missing fileName parameter for upload"},x={message:"Missing public key for upload"},k={message:"Request to ImageKit upload endpoint failed due to network error"},S={message:"Missing signature for upload. The SDK expects token, signature and expire for authentication."},R={message:"Missing token for upload. The SDK expects token, signature and expire for authentication."},E={message:"Missing expire for upload. The SDK expects token, signature and expire for authentication."},I={message:"Invalid transformation parameter. Please include at least pre, post, or both."},A={message:"Invalid pre transformation parameter."},M={message:"Invalid post transformation parameter."};class P extends Error{constructor(e,t){super(e),this.$ResponseMetadata=void 0,this.name="ImageKitInvalidRequestError",this.$ResponseMetadata=t}}class j extends Error{constructor(e,t){super(e),this.reason=void 0,this.name="ImageKitAbortError",this.reason=t}}class K extends Error{constructor(e){super(e),this.name="ImageKitUploadNetworkError"}}class O extends Error{constructor(e,t){super(e),this.$ResponseMetadata=void 0,this.name="ImageKitServerError",this.$ResponseMetadata=t}}const C=(e,t)=>{let r={...e};const n=q(t);return Object.defineProperty(r,"$ResponseMetadata",{value:n,enumerable:!1,writable:!1}),r},q=e=>{const t=function(e){const t={},r=e.getAllResponseHeaders();Object.keys(r).length&&r.trim().split(/[\r\n]+/).map(e=>e.split(/: /)).forEach(e=>{t[e[0].trim().toLowerCase()]=e[1].trim()});return t}(e);return{statusCode:e.status,headers:t,requestId:t["x-request-id"]}};e.ImageKitAbortError=j,e.ImageKitInvalidRequestError=P,e.ImageKitServerError=O,e.ImageKitUploadNetworkError=K,e.buildSrc=f,e.buildTransformationString=h,e.getResponsiveImageAttributes=function(e){const{src:t,urlEndpoint:r,transformation:n=[],queryParameters:s,transformationPosition:o,sizes:a,width:i,deviceBreakpoints:u=y,imageBreakpoints:c=v}=e,p=[...u].sort((e,t)=>e-t),l=[...[...c].sort((e,t)=>e-t),...p].sort((e,t)=>e-t),{candidates:d,descriptorKind:g}=function(e){const{allBreakpoints:t,deviceBreakpoints:r,explicitWidth:n,sizesAttr:s}=e;if(s){const e=(s.match(/(^|\s)(1?\d{1,2})vw/g)||[]).map(e=>parseInt(e,10));if(e.length){const n=Math.min(...e)/100,s=r[0]*n;return{candidates:t.filter(e=>e>=s),descriptorKind:"w"}}return{candidates:t,descriptorKind:"w"}}if("number"!=typeof n)return{candidates:r,descriptorKind:"w"};const o=e=>t.find(t=>t>=e)||t[t.length-1];return{candidates:Array.from(new Set([o(n),o(2*n)])),descriptorKind:"x"}}({allBreakpoints:l,deviceBreakpoints:p,explicitWidth:i,sizesAttr:a}),m=e=>f({src:t,urlEndpoint:r,queryParameters:s,transformationPosition:o,transformation:[...n,{width:e,crop:"at_max"}]}),h=d.map((e,t)=>`${m(e)} ${"w"===g?e:t+1}${g}`).join(", ")||void 0,b=a??("w"===g?"100vw":void 0);return{src:m(d[d.length-1]),srcSet:h,...b?{sizes:b}:{},...void 0!==i?{width:i}:{}}},e.upload=e=>e?new Promise((t,r)=>{const{xhr:n}=e||{};delete e.xhr;const s=n||new XMLHttpRequest;if(!e.file)return r(new P(b.message));if(!e.fileName)return r(new P(w.message));if(!e.publicKey||0===e.publicKey.length)return r(new P(x.message));if(!e.token)return r(new P(R.message));if(!e.signature)return r(new P(S.message));if(!e.expire)return r(new P(E.message));if(e.transformation){if(!Object.keys(e.transformation).includes("pre")&&!Object.keys(e.transformation).includes("post"))return r(new P(I.message));if(Object.keys(e.transformation).includes("pre")&&!e.transformation.pre)return r(new P(A.message));if(Object.keys(e.transformation).includes("post")){if(!Array.isArray(e.transformation.post))return r(new P(M.message));for(let t of e.transformation.post){if("abs"===t.type&&!t.protocol&&!t.value)return r(new P(M.message));if("transformation"===t.type&&!t.value)return r(new P(M.message))}}}var o=new FormData;let a;for(a in e)if(a)if("file"===a&&"string"!=typeof e.file)o.set("file",e.file,String(e.fileName));else if("tags"===a&&Array.isArray(e.tags))o.set("tags",e.tags.join(","));else if("signature"===a)o.set("signature",e.signature);else if("expire"===a)o.set("expire",String(e.expire));else if("token"===a)o.set("token",e.token);else if("responseFields"===a&&Array.isArray(e.responseFields))o.set("responseFields",e.responseFields.join(","));else if("extensions"===a&&Array.isArray(e.extensions))o.set("extensions",JSON.stringify(e.extensions));else if("customMetadata"!==a||"object"!=typeof e.customMetadata||Array.isArray(e.customMetadata)||null===e.customMetadata){if("transformation"===a&&"object"==typeof e.transformation&&null!==e.transformation)o.set(a,JSON.stringify(e.transformation));else if("checks"===a&&e.checks)o.set("checks",e.checks);else if(void 0!==e[a]){if(["onProgress","abortSignal"].includes(a))continue;o.set(a,String(e[a]))}}else o.set("customMetadata",JSON.stringify(e.customMetadata));function i(){var t;return s.abort(),r(new j("Upload aborted",null===(t=e.abortSignal)||void 0===t?void 0:t.reason))}if(e.onProgress&&(s.upload.onprogress=function(t){e.onProgress&&e.onProgress(t)}),e.abortSignal){var u;if(e.abortSignal.aborted)return r(new j("Upload aborted",null===(u=e.abortSignal)||void 0===u?void 0:u.reason));e.abortSignal.addEventListener("abort",i),s.addEventListener("loadend",()=>{e.abortSignal&&e.abortSignal.removeEventListener("abort",i)})}s.open("POST","https://upload.imagekit.io/api/v1/files/upload"),s.onerror=function(e){return r(new K(k.message))},s.onload=function(){if(s.status>=200&&s.status<300)try{var e=JSON.parse(s.responseText),n=C(e,s);return t(n)}catch(e){return r(e)}else if(s.status>=400&&s.status<500)try{e=JSON.parse(s.responseText);return r(new P(e.message??"Invalid request. Please check the parameters.",q(s)))}catch(e){return r(e)}else try{e=JSON.parse(s.responseText);return r(new O(e.message??"Server error occurred while uploading the file. This is rare and usually temporary.",q(s)))}catch(e){return r(new O("Server error occurred while uploading the file. This is rare and usually temporary.",q(s)))}},s.send(o)}):Promise.reject(new P("Invalid options provided for upload")),Object.defineProperty(e,"__esModule",{value:!0})}));
